{% extends "base.html" %}

{% block content %}
<div id="photoContainer" class="photo-scroll-container">
    <div id="photoGrid" class="photo-scroll-wrapper">
        <!-- Photos will be loaded here -->
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    const folderPath = '{{ folder_path }}';
    const sourcePhoto = '{{ source_photo }}';
    
    async function loadPhotos() {
        try {
            const response = await fetch(`/api/photos/${folderPath}`);
            const data = await response.json();
            const grid = document.getElementById('photoGrid');
            
            grid.innerHTML = '';
            
            if (data.photos.length === 0) {
                // If no photos found and we have source photo, show it
                if (sourcePhoto) {
                    const photoDiv = document.createElement('div');
                    photoDiv.className = 'photo-detail-item';
                    
                    const img = document.createElement('img');
                    img.src = `/static/fav_photo/${sourcePhoto}`;
                    img.className = 'photo-detail-image';
                    img.style.maxWidth = '100%';
                    // Use CSS class for max-height instead of inline style for better mobile support
                    img.style.width = 'auto';
                    img.style.height = 'auto';
                    img.loading = 'lazy';
                    
                    // Fade in when image loads
                    img.onload = function() {
                        this.classList.add('loaded');
                    };
                    if (img.complete) {
                        img.classList.add('loaded');
                    }
                    
                    photoDiv.appendChild(img);
                    grid.appendChild(photoDiv);
                    return;
                } else {
                    grid.innerHTML = '<p class="text-gray-600 text-center w-full">No photos found in this folder.</p>';
                    return;
                }
            }
            
            let sourcePhotoElement = null;
            
            // Only enable TikTok-style scrolling if there are multiple photos
            const enableSnapScroll = data.photos.length > 1;
            const photoContainer = document.getElementById('photoContainer');
            const photoItems = [];
            
            if (enableSnapScroll) {
                photoContainer.style.scrollSnapType = 'y mandatory';
            } else {
                photoContainer.style.scrollSnapType = 'none';
            }
            
            // First, create all photo elements
            data.photos.forEach((photo, index) => {
                const photoDiv = document.createElement('div');
                photoDiv.className = 'photo-detail-item';
                
                // Mark source photo for scrolling
                if (sourcePhoto && photo.filename === sourcePhoto) {
                    photoDiv.id = 'source-photo';
                    sourcePhotoElement = photoDiv;
                }
                
                if (enableSnapScroll) {
                    photoDiv.style.scrollSnapAlign = 'start';
                    photoDiv.style.scrollSnapStop = 'normal';
                    photoItems.push(photoDiv);
                }
                
                const img = document.createElement('img');
                img.src = photo.path;
                img.className = 'photo-detail-image';
                img.style.maxWidth = '100%';
                // Use CSS class for max-height instead of inline style for better mobile support
                img.style.width = 'auto';
                img.style.height = 'auto';
                img.loading = 'lazy';
                
                // Fade in when image loads
                img.onload = function() {
                    this.classList.add('loaded');
                };
                if (img.complete) {
                    img.classList.add('loaded');
                }
                
                photoDiv.appendChild(img);
                grid.appendChild(photoDiv);
            });
            
            // Setup custom scroll handling after all items are created
            if (enableSnapScroll && photoItems.length > 1) {
                let scrollTimeout = null;
                
                // Custom scroll handling for better control (mouse wheel) - desktop only
                const isMobile = window.innerWidth <= 767;
                if (!isMobile) {
                    photoContainer.addEventListener('wheel', (e) => {
                        const delta = e.deltaY;
                        const currentScroll = photoContainer.scrollTop;
                        const viewportHeight = photoContainer.clientHeight;
                        const currentIndex = Math.round(currentScroll / viewportHeight);
                        
                        if (Math.abs(delta) > 50) {
                            e.preventDefault();
                            
                            let nextIndex = currentIndex;
                            if (delta > 0 && currentIndex < photoItems.length - 1) {
                                nextIndex = currentIndex + 1;
                            } else if (delta < 0 && currentIndex > 0) {
                                nextIndex = currentIndex - 1;
                            }
                            
                            if (nextIndex !== currentIndex && photoItems[nextIndex]) {
                                // Cancel any pending scroll
                                if (scrollTimeout) {
                                    clearTimeout(scrollTimeout);
                                }
                                
                                // Immediately scroll to next photo
                                photoItems[nextIndex].scrollIntoView({ 
                                    behavior: 'smooth', 
                                    block: 'start' 
                                });
                            }
                        }
                    }, { passive: false });
                }
                
                // On mobile, rely on native scroll-snap for smooth scrolling
                // No custom touch handling needed - native scroll-snap works better
                
                // Handle keyboard arrow keys (on document level for better accessibility)
                let isKeyDown = false;
                let lastKeyIndex = -1;
                let keyRepeatTimeout = null;
                
                const handleKeyDown = (e) => {
                    // Only handle if container is visible and focused/active
                    if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA' || e.target.isContentEditable) {
                        return;
                    }
                    
                    const currentScroll = photoContainer.scrollTop;
                    const viewportHeight = photoContainer.clientHeight;
                    const currentIndex = Math.round(currentScroll / viewportHeight);
                    
                    // Prevent handling if we're already at the boundary
                    if ((e.key === 'ArrowDown' || e.key === 'PageDown') && currentIndex >= photoItems.length - 1) {
                        e.preventDefault();
                        return;
                    }
                    if ((e.key === 'ArrowUp' || e.key === 'PageUp') && currentIndex <= 0) {
                        e.preventDefault();
                        return;
                    }
                    
                    // Prevent key repeat spam on first/last photo
                    if (isKeyDown && lastKeyIndex === currentIndex) {
                        e.preventDefault();
                        return;
                    }
                    
                    let nextIndex = currentIndex;
                    let shouldScroll = false;
                    
                    if (e.key === 'ArrowDown' && currentIndex < photoItems.length - 1) {
                        e.preventDefault();
                        nextIndex = currentIndex + 1;
                        shouldScroll = true;
                    } else if (e.key === 'ArrowUp' && currentIndex > 0) {
                        e.preventDefault();
                        nextIndex = currentIndex - 1;
                        shouldScroll = true;
                    } else if (e.key === 'PageDown' && currentIndex < photoItems.length - 1) {
                        e.preventDefault();
                        nextIndex = currentIndex + 1;
                        shouldScroll = true;
                    } else if (e.key === 'PageUp' && currentIndex > 0) {
                        e.preventDefault();
                        nextIndex = currentIndex - 1;
                        shouldScroll = true;
                    }
                    
                    if (shouldScroll && nextIndex !== currentIndex && photoItems[nextIndex]) {
                        isKeyDown = true;
                        lastKeyIndex = currentIndex;
                        
                        // Cancel any pending scroll
                        if (scrollTimeout) {
                            clearTimeout(scrollTimeout);
                        }
                        if (keyRepeatTimeout) {
                            clearTimeout(keyRepeatTimeout);
                        }
                        
                        // Immediately scroll to next photo
                        photoItems[nextIndex].scrollIntoView({ 
                            behavior: 'smooth', 
                            block: 'start' 
                        });
                        
                        // Reset key state after scroll completes
                        keyRepeatTimeout = setTimeout(() => {
                            isKeyDown = false;
                            lastKeyIndex = -1;
                        }, 300);
                    }
                };
                
                const handleKeyUp = (e) => {
                    if (e.key === 'ArrowDown' || e.key === 'ArrowUp' || e.key === 'PageDown' || e.key === 'PageUp') {
                        isKeyDown = false;
                        lastKeyIndex = -1;
                        if (keyRepeatTimeout) {
                            clearTimeout(keyRepeatTimeout);
                            keyRepeatTimeout = null;
                        }
                    }
                };
                
                document.addEventListener('keydown', handleKeyDown);
                document.addEventListener('keyup', handleKeyUp);
                
                // Make container focusable for keyboard navigation
                photoContainer.setAttribute('tabindex', '0');
                photoContainer.focus();
            }
            
            // Scroll to source photo if it exists
            if (sourcePhotoElement) {
                setTimeout(() => {
                    if (enableSnapScroll) {
                        sourcePhotoElement.scrollIntoView({ behavior: 'smooth', block: 'start' });
                    } else {
                        sourcePhotoElement.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    }
                }, 100);
            }
        } catch (error) {
            console.error('Error loading photos:', error);
        }
    }
    
    loadPhotos();
</script>
{% endblock %}

